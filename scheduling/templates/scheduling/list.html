{% extends "base.html" %}

{% block title %}總班表{% endblock %}

{% block extra_css %}
<style>
/* 事件會蓋在 slot 上面（可點擊）*/
.fc-timegrid-event {
    position: relative !important;
    z-index: 20 !important;
    pointer-events: auto !important;
}

/* slot 和背景不阻擋事件 */
.fc-timegrid-slot,
.fc-timegrid-slot-lane {
    pointer-events: none !important;
}
/* === 固定每列高度為 40px（最佳視覺） === */
.fc-timegrid-slot,
.fc-timegrid-slot-lane {
    height: 40px !important;
    max-height: 40px !important;
    min-height: 40px !important;
}


/* 讓事件不要貼住上下邊 */
.fc-timegrid-event {
    margin-top: 3px !important;
    margin-bottom: 3px !important;
}

.fc-col-header-cell:hover {
    background: #f5f5f5;
}

</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">總班表（店長）</h2>

<div class="calendar-wrapper shadow-sm border rounded p-2 bg-white">
    <div id="shift-calendar"></div>
</div>

<!-- === 排班建立 Modal === -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">建立排班</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <h6 id="assignDateLabel" class="mb-3 text-primary"></h6>

                <div id="workerList"
                     class="border rounded p-3 bg-light"
                     style="min-height:120px;">
                    <!-- JS 塞可上班員工 -->
                </div>

                <div id="intersectionWarning"
                     class="text-danger mt-3 fw-bold"
                     style="display:none;">
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary" onclick="submitShift()">建立排班</button>
            </div>

        </div>
    </div>
</div>

<!-- 編輯 / 刪除 Shift Modal -->
<div class="modal fade" id="shiftModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">排班資訊</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p><strong>員工：</strong> <span id="m-employee"></span></p>
        <p><strong>日期：</strong> <span id="m-date"></span></p>

        <div class="row g-2">
          <div class="col">
            <label>開始時間</label>
            <input id="m-start" type="time" class="form-control">
          </div>
          <div class="col">
            <label>結束時間</label>
            <input id="m-end" type="time" class="form-control">
          </div>
        </div>

        <input type="hidden" id="m-id">

      </div>

      <div class="modal-footer">
        <button id="deleteShiftBtn" class="btn btn-danger">刪除</button>
        <button id="updateShiftBtn" class="btn btn-primary">更新</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    var calendarEl = document.getElementById('shift-calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'zh-tw',

        height: "auto",
        slotEventOverlap: false,
        eventOverlap: false,
        eventMaxStack: 3,

        slotMinTime: "06:00:00",
        slotMaxTime: "24:00:00",
        slotDuration: "01:00:00",
        slotLabelInterval: "01:00",
        allDaySlot: false,

        slotLabelFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        },
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        },

        eventClick: function(info) {
            console.log("eventClick", info.event);
            if (info.event.extendedProps.type !== "shift") {
                return;
            }

            document.getElementById("m-id").value = info.event.id;
            document.getElementById("m-employee").innerText = info.event.title;
            document.getElementById("m-date").innerText = info.event.startStr.slice(0, 10);
            document.getElementById("m-start").value = info.event.start.toISOString().slice(11, 16);
            document.getElementById("m-end").value = info.event.end.toISOString().slice(11, 16);

            var modal = new bootstrap.Modal(document.getElementById("shiftModal"));
            modal.show();

            info.jsEvent.stopPropagation();  // ← 防止影響 header click
        },

        viewDidMount: function(arg) {
            document.querySelectorAll(".fc-col-header-cell").forEach(cell => {
                cell.style.cursor = "pointer";
                cell.onclick = function(e) {
                    e.stopPropagation(); // ← 避免事件衝突
                    const dateStr = this.getAttribute("data-date");
                    if (dateStr) {
                        openAssignModal(dateStr);
                    }
                };
            });
        },

        events: "{% url 'scheduling:data' %}",

    });

    calendar.render();
});


// =================== 排班 Modal + 交集計算 ======================
let selection = {
    date: null,
    employees: [],
    start: null,
    end: null,
};

function openAssignModal(date) {
    selection = {date, employees: [], start: null, end: null};

    const cleanDate = date.slice(0, 10); // yyyy-mm-dd
    document.getElementById("assignDateLabel").innerText = `日期：${cleanDate}`;

    fetch(`/scheduling/available-workers/${date}/`)
        .then(res => res.json())
        .then(list => renderWorkers(list));

    new bootstrap.Modal(document.getElementById("assignModal")).show();
}

function renderWorkers(list) {
    let html = "";

    list.forEach(w => {
        html += `
            <div class="form-check mb-2">
                <input 
                    class="form-check-input worker-checkbox"
                    type="checkbox"
                    value="${w.id}" 
                    data-start="${w.start}"
                    data-end="${w.end}"
                    onchange="calcIntersection()">

                <label class="form-check-label">
                    ${w.name}（${w.start}–${w.end}）
                </label>
            </div>
        `;
    });

    document.getElementById("workerList").innerHTML = html;
}

function calcIntersection() {
    let ranges = [];
    let employees = [];

    document.querySelectorAll(".worker-checkbox:checked").forEach(cb => {
        ranges.push([cb.dataset.start, cb.dataset.end]);
        employees.push(cb.value);
    });

    if (!ranges.length) return;

    fetch("/scheduling/calc-intersection/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ranges}),
    })
    .then(res => res.json())
    .then(result => {
        if (!result.start) {
            document.getElementById("intersectionWarning").style.display = "";
            document.getElementById("intersectionWarning").innerText = 
                "⚠️ 選取的員工沒有共同可上班時間！";

            selection.start = null;
            selection.end = null;
            return;
        }

        document.getElementById("intersectionWarning").style.display = "none";
        selection.start = result.start;
        selection.end = result.end;
        selection.employees = employees;
    });
}

function submitShift() {
    if (!selection.start) {
        alert("沒有共同可上班時間，無法建立排班！");
        return;
    }

    fetch("/scheduling/create-shift/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(selection),
    })
    .then(res => res.json())
    .then(() => location.reload());
}

document.addEventListener("DOMContentLoaded", function () {

    // 等 FullCalendar 渲染完成一小段時間後綁定 header click
    setTimeout(function() {
        document.querySelectorAll(".fc-col-header-cell").forEach(cell => {
            cell.style.cursor = "pointer";  // hover 手勢
            cell.addEventListener("click", function () {

                const dateStr = this.getAttribute("data-date"); // YYYY-MM-DD
                if (dateStr) {
                    openAssignModal(dateStr);  // 開啟你的排班視窗
                }
            });
        });
    }, 300);
});

// 刪除 Shift
document.getElementById("deleteShiftBtn").addEventListener("click", function() {

    fetch("{% url 'scheduling:shift_delete' %}", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id: document.getElementById("m-id").value })
    })
    .then(r => r.json())
    .then(res => {
        calendar.refetchEvents();
        bootstrap.Modal.getInstance(document.getElementById("shiftModal")).hide();
    });
});


// 更新 Shift
document.getElementById("updateShiftBtn").addEventListener("click", function() {

    fetch("{% url 'scheduling:shift_update' %}", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id: document.getElementById("m-id").value,
            start: document.getElementById("m-start").value,
            end: document.getElementById("m-end").value
        })
    })
    .then(r => r.json())
    .then(res => {
        calendar.refetchEvents();
        bootstrap.Modal.getInstance(document.getElementById("shiftModal")).hide();
    });
});


</script>
{% endblock %}
