{% extends "base.html" %}
{% block title %}設定{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h2 class="mb-0">設定</h2>
    <a class="btn btn-outline-secondary" href="{% url 'scheduling:timeline' %}?view=week">回班表</a>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert {% if message.tags == 'error' %}alert-error{% else %}alert-{{ message.tags }}{% endif %}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="border rounded-3 p-3 h-100 d-flex flex-column">
          <h6 class="mb-3">可排班時間</h6>
          <form method="post" class="d-flex flex-column flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_dates">
            <div class="d-flex flex-column gap-2 flex-grow-1">
              <div>
                <label class="form-label">可排班開始日</label>
                <input class="form-control" type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" required>
              </div>
              <div class="row g-2">
                <div class="col">
                  <label class="form-label">可排班結束日</label>
                  <input class="form-control" type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" required>
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-2">
              <button type="submit" class="btn btn-primary">設定</button>
            </div>
          </form>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded-3 p-3 h-100 d-flex flex-column">
          <h6 class="mb-3">參數設定</h6>
          <form method="post" class="d-flex flex-column flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_permissions">
            <div class="d-flex flex-column gap-2 flex-grow-1">
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="allowWorkerView" name="allow_worker_view" {% if allow_worker_view %}checked{% endif %}>
                  <label class="form-check-label" for="allowWorkerView">
                    開放員工查看他人班表
                  </label>
                </div>
                <small class="text-muted d-block">未勾選時，員工無法查看他人班表。</small>
              </div>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="allowWorkerEditShifts" name="allow_worker_edit_shifts" {% if allow_worker_edit_shifts %}checked{% endif %}>
                  <label class="form-check-label" for="allowWorkerEditShifts">
                    開放員工排班
                  </label>
                </div>
                <small class="text-muted d-block">未勾選時，員工僅能查看，不可新增/修改班表。</small>
              </div>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="allowWorkerRegister" name="allow_worker_register" {% if allow_worker_register %}checked{% endif %}>
                  <label class="form-check-label" for="allowWorkerRegister">
                    開放員工註冊
                  </label>
                </div>
                <small class="text-muted d-block">未勾選時，登入頁的註冊按鈕會停用。</small>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
              <button type="submit" class="btn btn-primary">設定</button>
            </div>
          </form>
          <hr class="my-3">
          <form method="post" class="d-flex flex-column flex-grow-1" id="breakRuleForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_break_rules">
            <div class="d-flex flex-column gap-2 flex-grow-1" id="breakRules">
              {% if break_rules %}
                {% for rule in break_rules %}
                  <div class="row g-2 align-items-center break-rule-row">
                    <div class="col-5">
                      <div class="input-group">
                        <span class="input-group-text">排班超過</span>
                        <select class="form-select" name="break_threshold_hours">
                          <option value="">選擇</option>
                          {% for option in break_threshold_options %}
                            <option value="{{ option }}" {% if rule.min_time == option %}selected{% endif %}>{{ option }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                    <div class="col-5">
                      <div class="input-group">
                        <span class="input-group-text">休息</span>
                        <select class="form-select" name="break_minutes">
                          <option value="0" {% if rule.break_minutes == 0 %}selected{% endif %}>00:00</option>
                          <option value="30" {% if rule.break_minutes == 30 %}selected{% endif %}>00:30</option>
                          <option value="60" {% if rule.break_minutes == 60 %}selected{% endif %}>01:00</option>
                          <option value="90" {% if rule.break_minutes == 90 %}selected{% endif %}>01:30</option>
                          <option value="120" {% if rule.break_minutes == 120 %}selected{% endif %}>02:00</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-2 d-grid">
                      <button type="button" class="btn btn-outline-secondary btn-sm remove-break-rule">移除</button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="row g-2 align-items-center break-rule-row">
                  <div class="col-5">
                    <div class="input-group">
                      <span class="input-group-text">排班超過</span>
                      <select class="form-select" name="break_threshold_hours">
                        <option value="">選擇</option>
                        {% for option in break_threshold_options %}
                          <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="col-5">
                    <div class="input-group">
                      <span class="input-group-text">休息</span>
                      <select class="form-select" name="break_minutes">
                        <option value="0">00:00</option>
                        <option value="30">00:30</option>
                        <option value="60">01:00</option>
                        <option value="90">01:30</option>
                        <option value="120">02:00</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-2 d-grid">
                    <button type="button" class="btn btn-outline-secondary btn-sm remove-break-rule">移除</button>
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="d-flex flex-wrap gap-2 mt-3">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="addBreakRule">新增條件</button>
              <button type="submit" class="btn btn-primary btn-sm">設定排班休息時間</button>
            </div>
            <small class="text-muted mt-2">休息時間以半小時為單位，最多 2 小時。</small>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">店別設定</h5>
    <form method="post" class="row g-3 align-items-end">
      {% csrf_token %}
      <div class="col-md-6">
        <label class="form-label">新增店別</label>
        <input class="form-control" type="text" name="store_name" maxlength="50" placeholder="例如：林森店" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">顏色</label>
        <input class="form-control form-control-color" type="color" name="store_color" value="#cfe8ff" title="選擇顏色">
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary mt-3 mt-md-0 w-100">新增</button>
      </div>
    </form>
    {% if stores %}
    <div class="mt-3">
      <div class="text-muted small mb-2">目前店別</div>
      <div class="d-flex flex-column gap-2">
        {% for store in stores %}
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-secondary">{{ store.name }}</span>
          <form method="post" class="d-flex align-items-center gap-2">
            {% csrf_token %}
            <input type="hidden" name="store_id" value="{{ store.id }}">
            <input class="form-control form-control-color" type="color" name="store_color" value="{{ store.color }}" title="選擇顏色">
            <button type="submit" class="btn btn-outline-primary btn-sm">更新顏色</button>
          </form>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="delete_store_id" value="{{ store.id }}">
            <button type="submit" class="btn btn-outline-danger btn-sm">刪除</button>
          </form>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const breakRules = document.getElementById("breakRules");
  const addBreakRule = document.getElementById("addBreakRule");

  const resetBreakRow = (row) => {
    const thresholdSelect = row.querySelector('select[name="break_threshold_hours"]');
    const breakSelect = row.querySelector('select[name="break_minutes"]');
    if (thresholdSelect) {
      thresholdSelect.value = "";
    }
    if (breakSelect) {
      breakSelect.value = "0";
    }
  };

  if (addBreakRule && breakRules) {
    addBreakRule.addEventListener("click", () => {
      const baseRow = breakRules.querySelector(".break-rule-row");
      if (!baseRow) {
        return;
      }
      const newRow = baseRow.cloneNode(true);
      resetBreakRow(newRow);
      breakRules.appendChild(newRow);
    });

    breakRules.addEventListener("click", (event) => {
      if (!event.target.classList.contains("remove-break-rule")) {
        return;
      }
      const rows = breakRules.querySelectorAll(".break-rule-row");
      const row = event.target.closest(".break-rule-row");
      if (!row) {
        return;
      }
      if (rows.length <= 1) {
        resetBreakRow(row);
        return;
      }
      row.remove();
    });
  }
</script>
{% endblock %}
