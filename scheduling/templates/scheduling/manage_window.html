{% extends "base.html" %}
{% block title %}設定{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h2 class="mb-0">設定</h2>
    <a class="btn btn-outline-secondary" href="{% url 'scheduling:timeline' %}?view=week">回班表</a>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert {% if message.tags == 'error' %}alert-error{% else %}alert-{{ message.tags }}{% endif %}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="border rounded-3 p-3 h-100 d-flex flex-column">
          <h6 class="mb-3">可排班時間</h6>
          <form method="post" class="d-flex flex-column flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_dates">
            <div class="d-flex flex-column gap-2 flex-grow-1">
              <div>
                <label class="form-label">可排班開始日</label>
                <input class="form-control" type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" required>
              </div>
              <div>
                <label class="form-label">可排班結束日</label>
                <input class="form-control" type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" required>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
              <button type="submit" class="btn btn-primary">設定</button>
            </div>
          </form>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded-3 p-3 h-100 d-flex flex-column">
          <h6 class="mb-3">員工開放設定</h6>
          <form method="post" class="d-flex flex-column flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_permissions">
            <div class="d-flex flex-column gap-2 flex-grow-1">
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="allowWorkerView" name="allow_worker_view" {% if allow_worker_view %}checked{% endif %}>
                  <label class="form-check-label" for="allowWorkerView">
                    開放員工查看他人班表
                  </label>
                </div>
                <small class="text-muted d-block">未勾選時，員工無法查看他人班表。</small>
              </div>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="allowWorkerEditShifts" name="allow_worker_edit_shifts" {% if allow_worker_edit_shifts %}checked{% endif %}>
                  <label class="form-check-label" for="allowWorkerEditShifts">
                    開放員工排班
                  </label>
                </div>
                <small class="text-muted d-block">未勾選時，員工僅能查看，不可新增/修改班表。</small>
              </div>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="allowWorkerRegister" name="allow_worker_register" {% if allow_worker_register %}checked{% endif %}>
                  <label class="form-check-label" for="allowWorkerRegister">
                    開放員工註冊
                  </label>
                </div>
                <small class="text-muted d-block">未勾選時，登入頁的註冊按鈕會停用。</small>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
              <button type="submit" class="btn btn-primary">設定</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">店別設定</h5>
    <form method="post" class="row g-3 align-items-end">
      {% csrf_token %}
      <div class="col-md-6">
        <label class="form-label">新增店別</label>
        <input class="form-control" type="text" name="store_name" maxlength="50" placeholder="例如：林森店" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">顏色</label>
        <input class="form-control form-control-color" type="color" name="store_color" value="#cfe8ff" title="選擇顏色">
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary mt-3 mt-md-0 w-100">新增</button>
      </div>
    </form>
    {% if stores %}
    <div class="mt-3">
      <div class="text-muted small mb-2">目前店別</div>
      <div class="d-flex flex-column gap-2">
        {% for store in stores %}
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-secondary">{{ store.name }}</span>
          <form method="post" class="d-flex align-items-center gap-2">
            {% csrf_token %}
            <input type="hidden" name="store_id" value="{{ store.id }}">
            <input class="form-control form-control-color" type="color" name="store_color" value="{{ store.color }}" title="選擇顏色">
            <button type="submit" class="btn btn-outline-primary btn-sm">更新顏色</button>
          </form>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="delete_store_id" value="{{ store.id }}">
            <button type="submit" class="btn btn-outline-danger btn-sm">刪除</button>
          </form>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
