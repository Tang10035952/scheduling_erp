{% extends 'base.html' %}
{% load form_filters %}
{% block title %}員工管理{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <h2 class="mb-0">員工管理</h2>
  </div>
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <a class="btn btn-primary" href="{% url 'users:worker_create' %}">新增員工</a>
  <a class="btn btn-outline-secondary" href="{% url 'scheduling:timeline' %}?view=week">返回班表</a>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-success">{{ message }}</div>
  {% endfor %}
{% endif %}

<div class="card shadow-sm">
  <div class="card-body p-0">
    {% if workers %}
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle" id="workerTable">
        <thead class="table-light worker-table-head">
          <tr class="filter-row header-row">
            <th class="text-center align-top" style="width: 60px;">
              序號
            </th>
            <th>
              <div class="filter-label">帳號</div>
              <input type="text" class="form-control form-control-sm column-filter" data-field="username" placeholder="篩選帳號">
            </th>
            <th>
              <div class="filter-label">名稱</div>
              <input type="text" class="form-control form-control-sm column-filter" data-field="name" placeholder="篩選名稱">
            </th>
            <th>
              <div class="filter-label">真實姓名</div>
              <input type="text" class="form-control form-control-sm column-filter" data-field="real_name" placeholder="篩選真實姓名">
            </th>
            <th>
              <div class="filter-label">年齡</div>
              <input type="text" class="form-control form-control-sm column-filter" data-field="age" placeholder="篩選年齡">
            </th>
            <th class="text-center align-top">操作</th>
          </tr>
        </thead>
        <tbody>
          {% for worker in workers %}
          <tr data-worker-id="{{ worker.profile.id }}"
              data-worker-username="{{ worker.username }}"
              data-worker-name="{{ worker.display_name }}"
              data-worker-real-name="{{ worker.real_name }}"
              data-worker-age="{{ worker.age }}">
            <td class="text-center">{{ forloop.counter }}</td>
            <td>{{ worker.username }}</td>
            <td>
              <a href="{% url 'users:worker_detail' worker.profile.id %}" class="worker-name-link">
                {{ worker.display_name|default:worker.username }}
              </a>
              {% if worker.missing_info %}
                <span class="badge badge-warn-soft text-dark rounded-pill ms-2">尚未完成基本資料</span>
              {% endif %}
            </td>
            <td>{{ worker.real_name|default:"-" }}</td>
            <td>{{ worker.age }}</td>
            <td class="text-center">
              <form method="post" action="{% url 'users:delete_worker' %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="profile_id" value="{{ worker.profile.id }}">
                <button type="button" class="btn btn-outline-danger btn-sm delete-worker"
                        data-worker-name="{{ worker.display_name|default:worker.username }}">
                  刪除
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="p-3 text-muted">尚無員工帳號。</div>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="workerDeleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'users:delete_worker' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">刪除員工</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="profile_id" id="deleteWorkerId">
          <p class="mb-0">確定要刪除 <strong id="deleteWorkerName"></strong> 嗎？</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-danger">刪除</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_css %}
<style>
  .filter-row th {
    border-bottom: 0 !important;
    border-right: 1px solid #d1d9e2;
  }
  .filter-row th:last-child {
    border-right: 0;
  }
  .filter-label {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #2b3a45;
  }
  .filter-row .form-control {
    display: inline-block;
    width: 130px;
    background-color: #f7f9fb;
    border-color: #c7d0da;
    color: #2b3a45;
  }
  .worker-table-head .header-row th {
    background-color: #d6dde5 !important;
    color: #2b3a45;
  }
  #workerTable th,
  #workerTable td {
    border-right: 1px solid #d1d9e2;
  }
  #workerTable th:last-child,
  #workerTable td:last-child {
    border-right: 0;
  }
  .badge.rounded-pill {
    font-weight: 600;
  }
  .badge-warn-soft {
    background-color: #fff3bf;
    border: 1px solid #ffe69c;
  }
  .worker-name-link {
    color: #0b5ed7;
    text-decoration: none;
    font-weight: 400;
  }
  .worker-name-link:hover {
    color: #084298;
    text-decoration: underline;
    font-weight: 600;
  }
  .filter-row .form-control {
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
  }
  .filter-row .form-control::placeholder {
    color: #8e9aaa;
  }
  #workerTable tbody tr:hover {
    background-color: #f3f6f9;
  }
</style>
{% endblock %}
{% block extra_js %}
<script>
  document.querySelectorAll(".delete-worker").forEach((btn) => {
    btn.addEventListener("click", () => {
      const row = btn.closest("tr");
      const id = row ? row.dataset.workerId : "";
      const name = btn.dataset.workerName || "";
      const idInput = document.getElementById("deleteWorkerId");
      const nameText = document.getElementById("deleteWorkerName");
      if (!idInput || !nameText) return;
      idInput.value = id;
      nameText.textContent = name;
      bootstrap.Modal.getOrCreateInstance(document.getElementById("workerDeleteModal")).show();
    });
  });

  const rows = document.querySelectorAll("#workerTable tbody tr");
  const columnFilters = document.querySelectorAll(".column-filter");
  const applyFilters = () => {
    const filters = {};
    columnFilters.forEach((input) => {
      const value = input.value.trim().toLowerCase();
      if (value) {
        filters[input.dataset.field] = value;
      }
    });
    rows.forEach((row) => {
      const match = Object.entries(filters).every(([field, value]) => {
        const key = `worker${field.charAt(0).toUpperCase()}${field.slice(1).replace(/_([a-z])/g, (_, c) => c.toUpperCase())}`;
        const dataValue = (row.dataset[key] || "").toLowerCase();
        return dataValue.includes(value);
      });
      row.classList.toggle("d-none", !match);
    });
  };
  columnFilters.forEach((input) => {
    input.addEventListener("input", applyFilters);
  });
</script>
{% endblock %}
